
<!DOCTYPE html>
<html lang="zh-tw">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="我是山姆鍋">
    <title>我的 K8S DevOps 實驗環境 - 控制平面端點 - 我是山姆鍋</title>
    <meta name="author" content="Sampot (山姆鍋)">
    
    
        <link rel="icon" href="https://samkuo.me/images/favicon.png">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sampot (山姆鍋)","sameAs":["https://github.com/sampot","https://twitter.com/sampotkuo","https://facebook.com/sampotkuo","https://tw.linkedin.com/in/sampot","/contact","/sitemap"],"image":"logo.png"},"articleBody":"本文延續「我的 K8S DevOps 實驗環境 - 基礎篇」，針對其中的控制平面端點 (control-plane endpoint) 加以說明。作為高可用 K8S 叢集的必要元件，控制平面端點需要負責提供 API 服務的負載均衡 (load balancing) 以及錯誤轉移 (failover) 機制，山姆鍋藉由 HAProxy 以及 Keepalived 來實現控制平面端點。\n\nK8S 控制平面元件\n工作負載 (workload) 的高可用 (high availability) 由 K8S 負責提供，所以，高可用 K8S 叢集主要在確保 K8S 控制平面元件的冗余，也就是確保服務 (e.g. API server) 可以容錯，使得叢集內的排程工作持續順利進行。\n\n下圖由 Kubernetes 官方文件所提供，這裡主要目的在於展示控制平面元件。\n\n下面各小節簡介控制平面元件以及說明該元件採用的高可用模式。\nAPI Server\n提供 K8S 的 API 服務，屬於無狀態 (stateless) 元件，所以，叢集中的每個 API Server 實例 (instance) 都可以提供服務。本文所謂的「控制平面端點」就是為了隱藏 API Server 實例的故障以及將請求分散給不同的實例來均衡負載。\nKube Controller Manager\nController 負責確保叢集內某類特定資源的狀態與 API Server 回傳的狀態一致，Controller Manager 提供這些 controller 的執行支援。Controller Manager 的高可用採用 leader-followers 模式，同一時間只有作為 leader 的 Controller Manager 實際在運作，其餘實例在現任 leader 故障時重新選舉新 leader 接替。\nScheduler\n負責叢集中工作負載的主要排程服務，例如，決定 Pod 要配置到哪個節點。同一時間只有一個 Scheduler 在負責排程工作，其餘實例作為熱備援 (hot standby) 可以隨時接替工作。\nEtcd\n分散式資料存儲，叢集內的資源資料與狀態都存放在此。由於 Etcd 的元件內部使用 Raft 共識演算法，元件分別扮演 leader 或者 follower 角色。Etcd 叢集寫入 (write) 操作都由 leader 元件接受並將結果複製到叢集中的所有 follower 元件。由於 leader 選舉採用多數決 (quorum)，因此，Etcd 叢集需由奇數個實例組成 (至少 3 個，生產環境建議為 5 個)。 Etcd 叢集可以選擇部署在與其它 K8S 控制元件分開的節點，但此實驗環境選擇較簡單的架構，每一台控制節點 (master/control-plane node) 都部署上述元件的實例。\n\n雖然此實驗環境使用 Etcd 作為叢集高可用資料存儲，但不同的 K8S 發行版本可能採用別的方案。例如，K3S 也可以支援 MySQL/PostgreSQL 作為資料存儲。\n\n控制平面端點\n從架構圖可以得知，多數 K8S 的控制平面元件，包括 Kubelet 守護行程 (daemon) 以及客戶端程式等都需要呼叫 API Server。由於有多個 API Server 實例，需要提供一個統一固定的存取點來簡化 K8S API 客戶端呼叫 (e.g. kubelet 只能設定一個 API server 端點) 以及隱藏故障移轉過程的影響。傳統上，對於一組提供相同服務的守護行程 (daemons) 都是透過服務負載均衡器 (server loadbalancer) 來分散請求到不同副本 (replica)。有了服務負載均衡器雖然可以增加服務請求的數量以及效率，但如果負載均衡器故障則會影響到客戶端。所以，常利用虛擬 IP 來讓兩個以上的負載均衡器可以互相備援。\n此實驗環境分別採用 Keepalived 來實現虛擬 IP 位址，以及透過 HAProxy 來提供 API 服務的負載均衡。從山姆鍋開始研究 Linux HA 開始，這個組合就是常常出現的方案且是經得起時間考驗的。\nKeepalived 安裝設定\n透過 ARP 協定，節點可以廣播所屬網卡的 IP 位址讓其它節點可以找到 IP 所對應的網卡硬體位址 (MAC Address) 以完成封包的路由 (routing)。根據服務節點的健康狀態，可以選擇性地由不同節點來廣播 ARP 封包從而實現虛擬 IP 的錯誤移轉。Keepalived 作為支援 VRRP 的 Linux 高可用元件，除了可以實現前述的虛擬 IP 功能外，當發生錯誤轉移時可以呼叫自訂的腳本。這點對於無法在網卡層面支援虛擬 IP 的環境 (如 DigitalOcean 等雲端服務)，但支援 API 來動態綁定浮動 (floating) IP 的情境可以達成與虛擬 IP 相同的目的。因此，在機房或者雲端自建 K8S 叢集都有機會可以使用 HAProxy + Keepalived 來實現高可用的負載均衡服務。但即使如此，除非有特別考量，山姆鍋還是傾向於使用雲端託管的 K8S 服務的。\n\n如果只是為了高可用，其實可以只使用 Keepalived 來提供。基於此實驗環境目標之一是盡可能接近生產環境設定，所以也採用負載均衡器以充分利用系統效能。\n\nKeepalived 以系統套件安裝並以守護行程 (daemon) 方式執行：\n1apt-get install -y keepalived\n下面是 /etc/keepalived/keepalived.conf 設定檔內容樣板 (template)：\n12345678910111213141516171819202122global_defs {  default_interface ${SPK_KEEPALIVED_INTERFACE}}vrrp_instance VI_1 {    interface ${SPK_KEEPALIVED_INTERFACE}    virtual_router_id 101    nopreempt    advert_int 1    authentication {        auth_type PASS        auth_pass 1111    }    unicast_src_ip ${API_ADV_ADDRESS}    unicast_peer {      ${SPK_LAB_NETWORK}.11      ${SPK_LAB_NETWORK}.12      ${SPK_LAB_NETWORK}.13    }    virtual_ipaddress {        ${SPK_KEEPALIVED_VIRTUAL_IP}    }}\n其中，\n\n\n${SPK_KEEPALIVED_INTERFACE}: 是虛擬 IP 預計綁定的網卡。由於 Vagrant 設定的虛擬機中，第一張網卡是 NAT 模式，此實驗環境使用第二張網卡作為叢集內節點的通訊用途，第二張網卡的預設名稱是 eth1。\n\n\n${API_ADV_ADDRESS}: 此 IP 位址就是 Keepalived 實例所在的控制節點 IP 位址。\n\n\n${SPK_KEEPALIVED_VIRTUAL_IP}：此變數就是 API 服務的虛擬 IP 位址，預設是 172.42.42.10。\n\n\n${SPK_LAB_NETWORK}.11 ~ .13: 基於雲端環境多數不支援 IP Multicast 的假設下，Keepalived 透過 unicast 來進行對等點 (peer) 偵測工作。\n\n\n\n注意: Keepalived 設定 nopreempt，且沒有設定 priority(所以每個實例優先權相同)。這樣做的目的是為了避免較高優先權的 keepalived 恢復後將 IP 轉移回去 (failback)，造成現有的 TCP 連線中斷。\n\n設定修改完成後，重啟 Keepalived 守護行程：\n1systemctl restart keepalived\nHAProxy 安裝設定\n由於 API Server 的負載均衡只需要依賴 IP 跟 Port，所以只需要可以支援 TCP (layer 4) 的負載均衡器即可。常用的選項是 HAProxy 以及 Nginx，此實驗環境選用 HAProxy 來作為 API Server 的負載均衡器。\nHAProxy 同樣使用系統套件安裝：\n1apt-get install -y haproxy\n底下為 HAProxy 的 /etc/haproxy/haproxy.cfg 設定檔樣板：\n123456789101112131415161718192021222324252627282930global        log /dev/log    local0        log /dev/log    local1 notice        chroot /var/lib/haproxy        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners        stats timeout 30s        user haproxy        group haproxy        daemon        ca-base /etc/ssl/certs        crt-base /etc/ssl/privatefrontend spk-frontend        bind *:16443        mode tcp        log global        option tcplog        timeout client 3600s        backlog 4096        maxconn 50000        use_backend spk-mastersbackend spk-masters        mode  tcp        option redispatch        balance roundrobin        timeout connect 1s        timeout queue 5s        timeout server 3600s        server spkmaster-1 ${SPK_LAB_NETWORK}.11:6443 check        server spkmaster-2 ${SPK_LAB_NETWORK}.12:6443 check        server spkmaster-3 ${SPK_LAB_NETWORK}.13:6443 check\n其中，\n\n此實驗環境的控制平面端點採用 16443 port，而個別 API Server 則是使用 6443 port。\n${SPK_LAB_NETWORK}: 實驗環境網段位址前置字串，預設是 172.42.42。\n可以看出 3 個控制節點的 API Server 端點是寫死的。\n\n設定修改完成後，重啟 HAProxy 守護行程：\n1systemctl restart haproxy\n小結\n在網路上有看過利用 Kubelet 以靜態 Pod 形式執行 HAProxy 以及 Keepalived 的參考文件。但此實驗環境使用的 kubeadm 版本在執行 kubeadm init 或者 kubeadm join 之前，kubelet 並不會正常執行。由於控制平面端點在 kubeadm init 執行前就要正常啟動，這導致無法利用靜態 Pod 形式來部署。另一個替代方式是以 Docker 容器來執行 HAProxy 以及 Keepalived, 也許之後的版本會改採用這種方式。\n參考文章\n\n實現 Kubernetes 高可靠架構部署: 這篇文章使用靜態 Pod 方式來執行 HAProxy 以及 Keepalived。\n\n","dateCreated":"2020-06-05T17:49:25+08:00","dateModified":"2020-06-07T09:35:01+08:00","datePublished":"2020-06-05T17:49:25+08:00","description":"本文延續「我的 K8S DevOps 實驗環境 - 基礎篇」，針對其中的控制平面端點(control-plane endpoint)加以說明。作為高可用 K8S 叢集的必要元件，控制平面端點需要負責提供 API 服務的負載均衡(load balancing)以及錯誤轉移(failover)機制，山姆鍋藉由 HAProxy 以及 Keepalived 來實現控制平面端點。","headline":"我的 K8S DevOps 實驗環境 - 控制平面端點","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"},"publisher":{"@type":"Organization","name":"Sampot (山姆鍋)","sameAs":["https://github.com/sampot","https://twitter.com/sampotkuo","https://facebook.com/sampotkuo","https://tw.linkedin.com/in/sampot","/contact","/sitemap"],"image":"logo.png","logo":{"@type":"ImageObject","url":"logo.png"}},"url":"https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/","keywords":"Kubernetes, DevOps, SPK Cluster, High Availability, Linux HA"}</script>
    <meta name="description" content="本文延續「我的 K8S DevOps 實驗環境 - 基礎篇」，針對其中的控制平面端點(control-plane endpoint)加以說明。作為高可用 K8S 叢集的必要元件，控制平面端點需要負責提供 API 服務的負載均衡(load balancing)以及錯誤轉移(failover)機制，山姆鍋藉由 HAProxy 以及 Keepalived 來實現控制平面端點。">
<meta property="og:type" content="blog">
<meta property="og:title" content="我的 K8S DevOps 實驗環境 - 控制平面端點">
<meta property="og:url" content="https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/">
<meta property="og:site_name" content="我是山姆鍋">
<meta property="og:description" content="本文延續「我的 K8S DevOps 實驗環境 - 基礎篇」，針對其中的控制平面端點(control-plane endpoint)加以說明。作為高可用 K8S 叢集的必要元件，控制平面端點需要負責提供 API 服務的負載均衡(load balancing)以及錯誤轉移(failover)機制，山姆鍋藉由 HAProxy 以及 Keepalived 來實現控制平面端點。">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://d33wubrfki0l68.cloudfront.net/7016517375d10c702489167e704dcb99e570df85/7bb53/images/docs/components-of-kubernetes.png">
<meta property="article:published_time" content="2020-06-05T09:49:25.000Z">
<meta property="article:modified_time" content="2020-06-07T01:35:01.042Z">
<meta property="article:author" content="Sampot (山姆鍋)">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="DevOps">
<meta property="article:tag" content="SPK Cluster">
<meta property="article:tag" content="High Availability">
<meta property="article:tag" content="Linux HA">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://d33wubrfki0l68.cloudfront.net/7016517375d10c702489167e704dcb99e570df85/7bb53/images/docs/components-of-kubernetes.png">
<meta name="twitter:creator" content="@sampotkuo">
<meta property="fb:app_id" content="1538037013031361">
    
    
        
    
    <meta property="og:image" content="https://samkuo.me/images/featured_image.jpg"/>
    
    
    
    <!--STYLES-->
    
<link rel="stylesheet" href="/assets/css/style-lfspghztdttlloh4nly9hmp3cqmehlzaagf5ften7wo63faxiltzljjm4fb0.min.css">

    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-41152700-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-41152700-1');
    </script>


    

    
        
    
</head>

    <body>
        <div id="fb-root"></div>
        <script async defer crossorigin="anonymous"
            src="https://connect.facebook.net/zh_TW/sdk.js#xfbml=1&version=v7.0&appId=1538037013031361&autoLogAppEvents=1"></script>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="4">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
        <img class="header-avatar-picture" src="/images/logo32.png" alt="作者的圖片" />
            我是山姆鍋
        </a>
    </div>
    
        
            <a
                class="header-right-icon open-algolia-search"
                href="#search"
                aria-label="打開鏈接: /#search"
            >
        
        
            <i class="fa fa-search fa-lg"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="4">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="閱讀有關作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/images/logo.png" alt="作者的圖片"/>
                </a>
                <h4 class="sidebar-profile-name">Sampot (山姆鍋)</h4>
                
                    <h5 class="sidebar-profile-bio"><p>個人部落格， 記錄與分享一些軟體開發與運維相關資訊， 偶爾也會碎念一下</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首頁"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首頁</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分類"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分類</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="標籤"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">標籤</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="所有文章"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">所有文章</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜尋"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜尋</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/about"
                            
                            rel="noopener"
                            title="關於"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">關於</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/sampot"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/sampotkuo"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://facebook.com/sampotkuo"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://tw.linkedin.com/in/sampot"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/contact"
                            
                            rel="noopener"
                            title="聯絡"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">聯絡</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/sitemap"
                            
                            rel="noopener"
                            title="網站導覽"
                        >
                        <i class="sidebar-button-icon fa fa-sitemap" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">網站導覽</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://feedly.com/i/subscription/feed/https://samkuo.me/atom.xml"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Atom"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Atom</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="4"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            我的 K8S DevOps 實驗環境 - 控制平面端點
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2020-06-05T17:49:25+08:00">
	
		    6月 05, 2020
    	
    </time>
    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <div class="alert info no-icon">
                我是山姆鍋 <div class="fb-like" data-href="https://www.facebook.com/sampotkuo" data-width="" data-layout="standard" data-action="like" data-size="large" data-share="false"></div>
            </div>

            <p>本文延續「<a href="/post/2020/05/my-k8s-devops-lab-env/" title="我的 K8S DevOps 實驗環境 - 基礎篇">我的 K8S DevOps 實驗環境 - 基礎篇</a>」，針對其中的控制平面端點 (control-plane endpoint) 加以說明。作為高可用 K8S 叢集的必要元件，控制平面端點需要負責提供 API 服務的負載均衡 (load balancing) 以及錯誤轉移 (failover) 機制，山姆鍋藉由 HAProxy 以及 Keepalived 來實現控制平面端點。</p>
<a id="more"></a>
<h2 id="K8S-控制平面元件">K8S 控制平面元件</h2>
<p>工作負載 (workload) 的高可用 (high availability) 由 K8S 負責提供，所以，高可用 K8S 叢集主要在確保 K8S 控制平面元件的冗余，也就是確保服務 (e.g. API server) 可以容錯，使得叢集內的排程工作持續順利進行。</p>
<hr>
<p><em>下圖由 Kubernetes 官方文件所提供，這裡主要目的在於展示控制平面元件。</em></p>
<div class="figure " style="width:;"><img class="fig-img" src="https://d33wubrfki0l68.cloudfront.net/7016517375d10c702489167e704dcb99e570df85/7bb53/images/docs/components-of-kubernetes.png" alt=""></div>
<p>下面各小節簡介控制平面元件以及說明該元件採用的高可用模式。</p>
<h3 id="API-Server">API Server</h3>
<p>提供 K8S 的 API 服務，屬於無狀態 (stateless) 元件，所以，叢集中的每個 API Server 實例 (instance) 都可以提供服務。本文所謂的「控制平面端點」就是為了隱藏 API Server 實例的故障以及將請求分散給不同的實例來均衡負載。</p>
<h2 id="Kube-Controller-Manager">Kube Controller Manager</h2>
<p>Controller 負責確保叢集內某類特定資源的狀態與 API Server 回傳的狀態一致，Controller Manager 提供這些 controller 的執行支援。Controller Manager 的高可用採用 leader-followers 模式，同一時間只有作為 leader 的 Controller Manager 實際在運作，其餘實例在現任 leader 故障時重新選舉新 leader 接替。</p>
<h2 id="Scheduler">Scheduler</h2>
<p>負責叢集中工作負載的主要排程服務，例如，決定 Pod 要配置到哪個節點。同一時間只有一個 Scheduler 在負責排程工作，其餘實例作為熱備援 (hot standby) 可以隨時接替工作。</p>
<h2 id="Etcd">Etcd</h2>
<p>分散式資料存儲，叢集內的資源資料與狀態都存放在此。由於 Etcd 的元件內部使用 <a href="https://zh.wikipedia.org/wiki/Raft" target="_blank" rel="noopener">Raft</a> 共識演算法，元件分別扮演 leader 或者 follower 角色。Etcd 叢集寫入 (write) 操作都由 leader 元件接受並將結果複製到叢集中的所有 follower 元件。由於 leader 選舉採用多數決 (quorum)，因此，Etcd 叢集需由奇數個實例組成 (至少 3 個，生產環境建議為 5 個)。 Etcd 叢集可以選擇部署在與其它 K8S 控制元件分開的節點，但此實驗環境選擇較簡單的架構，每一台控制節點 (master/control-plane node) 都部署上述元件的實例。</p>
<blockquote>
<p>雖然此實驗環境使用 Etcd 作為叢集高可用資料存儲，但不同的 K8S 發行版本可能採用別的方案。例如，K3S 也可以支援 MySQL/PostgreSQL 作為資料存儲。</p>
</blockquote>
<h2 id="控制平面端點">控制平面端點</h2>
<p>從架構圖可以得知，多數 K8S 的控制平面元件，包括 Kubelet 守護行程 (daemon) 以及客戶端程式等都需要呼叫 API Server。由於有多個 API Server 實例，需要提供一個統一固定的存取點來簡化 K8S API 客戶端呼叫 (e.g. kubelet 只能設定一個 API server 端點) 以及隱藏故障移轉過程的影響。傳統上，對於一組提供相同服務的守護行程 (daemons) 都是透過服務負載均衡器 (server loadbalancer) 來分散請求到不同副本 (replica)。有了服務負載均衡器雖然可以增加服務請求的數量以及效率，但如果負載均衡器故障則會影響到客戶端。所以，常利用虛擬 IP 來讓兩個以上的負載均衡器可以互相備援。</p>
<p>此實驗環境分別採用 Keepalived 來實現虛擬 IP 位址，以及透過 HAProxy 來提供 API 服務的負載均衡。從山姆鍋開始研究 Linux HA 開始，這個組合就是常常出現的方案且是經得起時間考驗的。</p>
<h3 id="Keepalived-安裝設定">Keepalived 安裝設定</h3>
<p>透過 <a href="https://zh.wikipedia.org/wiki/%E5%9C%B0%E5%9D%80%E8%A7%A3%E6%9E%90%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">ARP</a> 協定，節點可以廣播所屬網卡的 IP 位址讓其它節點可以找到 IP 所對應的網卡硬體位址 (MAC Address) 以完成封包的路由 (routing)。根據服務節點的健康狀態，可以選擇性地由不同節點來廣播 ARP 封包從而實現虛擬 IP 的錯誤移轉。Keepalived 作為支援 <a href="https://zh.wikipedia.org/wiki/%E8%99%9B%E6%93%AC%E8%B7%AF%E7%94%B1%E5%99%A8%E5%82%99%E6%8F%B4%E5%8D%94%E5%AE%9A" target="_blank" rel="noopener">VRRP</a> 的 Linux 高可用元件，除了可以實現前述的虛擬 IP 功能外，當發生錯誤轉移時可以呼叫自訂的腳本。這點對於無法在網卡層面支援虛擬 IP 的環境 (如 DigitalOcean 等雲端服務)，但支援 API 來動態綁定浮動 (floating) IP 的情境可以達成與虛擬 IP 相同的目的。因此，在機房或者雲端自建 K8S 叢集都有機會可以使用 HAProxy + Keepalived 來實現高可用的負載均衡服務。但即使如此，除非有特別考量，山姆鍋還是傾向於使用雲端託管的 K8S 服務的。</p>
<blockquote>
<p>如果只是為了高可用，其實可以只使用 Keepalived 來提供。基於此實驗環境目標之一是盡可能接近生產環境設定，所以也採用負載均衡器以充分利用系統效能。</p>
</blockquote>
<p>Keepalived 以系統套件安裝並以守護行程 (daemon) 方式執行：</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y keepalived</span><br></pre></td></tr></tbody></table></figure>
<p>下面是 /etc/keepalived/keepalived.conf 設定檔內容樣板 (template)：</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">global_defs {</span><br><span class="line">  default_interface <span class="variable">${SPK_KEEPALIVED_INTERFACE}</span></span><br><span class="line">}</span><br><span class="line">vrrp_instance VI_1 {</span><br><span class="line">    interface <span class="variable">${SPK_KEEPALIVED_INTERFACE}</span></span><br><span class="line">    virtual_router_id 101</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication {</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    }</span><br><span class="line">    unicast_src_ip <span class="variable">${API_ADV_ADDRESS}</span></span><br><span class="line">    unicast_peer {</span><br><span class="line">      <span class="variable">${SPK_LAB_NETWORK}</span>.11</span><br><span class="line">      <span class="variable">${SPK_LAB_NETWORK}</span>.12</span><br><span class="line">      <span class="variable">${SPK_LAB_NETWORK}</span>.13</span><br><span class="line">    }</span><br><span class="line">    virtual_ipaddress {</span><br><span class="line">        <span class="variable">${SPK_KEEPALIVED_VIRTUAL_IP}</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>其中，</p>
<ul>
<li>
<p>${SPK_KEEPALIVED_INTERFACE}: 是虛擬 IP 預計綁定的網卡。由於 Vagrant 設定的虛擬機中，第一張網卡是 NAT 模式，此實驗環境使用第二張網卡作為叢集內節點的通訊用途，第二張網卡的預設名稱是 <code>eth1</code>。</p>
</li>
<li>
<p>${API_ADV_ADDRESS}: 此 IP 位址就是 Keepalived 實例所在的控制節點 IP 位址。</p>
</li>
<li>
<p>${SPK_KEEPALIVED_VIRTUAL_IP}：此變數就是 API 服務的虛擬 IP 位址，預設是 <code>172.42.42.10</code>。</p>
</li>
<li>
<p>${SPK_LAB_NETWORK}.11 ~ .13: 基於雲端環境多數不支援 IP Multicast 的假設下，Keepalived 透過 unicast 來進行對等點 (peer) 偵測工作。</p>
</li>
</ul>
<blockquote>
<p>注意: Keepalived 設定 <code>nopreempt</code>，且沒有設定 <code>priority</code>(所以每個實例優先權相同)。這樣做的目的是為了避免較高優先權的 keepalived 恢復後將 IP 轉移回去 (failback)，造成現有的 TCP 連線中斷。</p>
</blockquote>
<p>設定修改完成後，重啟 Keepalived 守護行程：</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart keepalived</span><br></pre></td></tr></tbody></table></figure>
<h3 id="HAProxy-安裝設定">HAProxy 安裝設定</h3>
<p>由於 API Server 的負載均衡只需要依賴 IP 跟 Port，所以只需要可以支援 TCP (layer 4) 的負載均衡器即可。常用的選項是 HAProxy 以及 Nginx，此實驗環境選用 HAProxy 來作為 API Server 的負載均衡器。</p>
<p>HAProxy 同樣使用系統套件安裝：</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install -y haproxy</span><br></pre></td></tr></tbody></table></figure>
<p>底下為 HAProxy 的 <code>/etc/haproxy/haproxy.cfg</code> 設定檔樣板：</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">global</span><br><span class="line">        <span class="built_in">log</span> /dev/<span class="built_in">log</span>    local0</span><br><span class="line">        <span class="built_in">log</span> /dev/<span class="built_in">log</span>    local1 notice</span><br><span class="line">        chroot /var/lib/haproxy</span><br><span class="line">        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners</span><br><span class="line">        stats timeout 30s</span><br><span class="line">        user haproxy</span><br><span class="line">        group haproxy</span><br><span class="line">        daemon</span><br><span class="line">        ca-base /etc/ssl/certs</span><br><span class="line">        crt-base /etc/ssl/private</span><br><span class="line">frontend spk-frontend</span><br><span class="line">        <span class="built_in">bind</span> *:16443</span><br><span class="line">        mode tcp</span><br><span class="line">        <span class="built_in">log</span> global</span><br><span class="line">        option tcplog</span><br><span class="line">        timeout client 3600s</span><br><span class="line">        backlog 4096</span><br><span class="line">        maxconn 50000</span><br><span class="line">        use_backend spk-masters</span><br><span class="line">backend spk-masters</span><br><span class="line">        mode  tcp</span><br><span class="line">        option redispatch</span><br><span class="line">        balance roundrobin</span><br><span class="line">        timeout connect 1s</span><br><span class="line">        timeout queue 5s</span><br><span class="line">        timeout server 3600s</span><br><span class="line">        server spkmaster-1 <span class="variable">${SPK_LAB_NETWORK}</span>.11:6443 check</span><br><span class="line">        server spkmaster-2 <span class="variable">${SPK_LAB_NETWORK}</span>.12:6443 check</span><br><span class="line">        server spkmaster-3 <span class="variable">${SPK_LAB_NETWORK}</span>.13:6443 check</span><br></pre></td></tr></tbody></table></figure>
<p>其中，</p>
<ol>
<li>此實驗環境的控制平面端點採用 16443 port，而個別 API Server 則是使用 6443 port。</li>
<li>${SPK_LAB_NETWORK}: 實驗環境網段位址前置字串，預設是 <code>172.42.42</code>。</li>
<li>可以看出 3 個控制節點的 API Server 端點是寫死的。</li>
</ol>
<p>設定修改完成後，重啟 HAProxy 守護行程：</p>
<figure class="highlight sh"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart haproxy</span><br></pre></td></tr></tbody></table></figure>
<h2 id="小結">小結</h2>
<p>在網路上有看過利用 Kubelet 以靜態 Pod 形式執行 HAProxy 以及 Keepalived 的參考文件。但此實驗環境使用的 kubeadm 版本在執行 <code>kubeadm init</code> 或者 <code>kubeadm join</code> 之前，kubelet 並不會正常執行。由於控制平面端點在 <code>kubeadm init</code> 執行前就要正常啟動，這導致無法利用靜態 Pod 形式來部署。另一個替代方式是以 Docker 容器來執行 HAProxy 以及 Keepalived, 也許之後的版本會改採用這種方式。</p>
<h2 id="參考文章">參考文章</h2>
<ul>
<li><a href="https://k2r2bai.com/2019/09/20/ironman2020/day05/" target="_blank" rel="noopener">實現 Kubernetes 高可靠架構部署</a>: 這篇文章使用靜態 Pod 方式來執行 HAProxy 以及 Keepalived。</li>
</ul>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">標籤</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tag/devops/" rel="tag">DevOps</a> <a class="tag tag--primary tag--small t-link" href="/tag/high-availability/" rel="tag">High Availability</a> <a class="tag tag--primary tag--small t-link" href="/tag/kubernetes/" rel="tag">Kubernetes</a> <a class="tag tag--primary tag--small t-link" href="/tag/linux-ha/" rel="tag">Linux HA</a> <a class="tag tag--primary tag--small t-link" href="/tag/spk-cluster/" rel="tag">SPK Cluster</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/post/2020/06/my-k8s-devops-lab-node-installation/"
                    data-tooltip="我的 K8S DevOps 實驗環境 - 節點安裝"
                    aria-label="上一篇: 我的 K8S DevOps 實驗環境 - 節點安裝"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/post/2020/05/my-k8s-devops-lab-env/"
                    data-tooltip="我的 K8S DevOps 實驗環境 - 基礎篇"
                    aria-label="下一篇: 我的 K8S DevOps 實驗環境 - 基礎篇"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Sampot (山姆鍋). All Rights Reserved.
    </span>
    <br/>
        <a rel="license"
            href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW"><img
                alt="創用 CC 授權條款" style="border-width:0"
                src="https://i.creativecommons.org/l/by-nc-sa/4.0/80x15.png" /></a>
        除另有標示，本著作係採用<a rel="license"
            href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh_TW">創用 CC
            姓名標示-非商業性-相同方式分享 4.0 國際 授權條款</a>授權。
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/post/2020/06/my-k8s-devops-lab-node-installation/"
                    data-tooltip="我的 K8S DevOps 實驗環境 - 節點安裝"
                    aria-label="上一篇: 我的 K8S DevOps 實驗環境 - 節點安裝"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/post/2020/05/my-k8s-devops-lab-env/"
                    data-tooltip="我的 K8S DevOps 實驗環境 - 基礎篇"
                    aria-label="下一篇: 我的 K8S DevOps 實驗環境 - 基礎篇"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Leave a comment"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="4">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/images/logo.png" alt="作者的圖片"/>
        
            <h4 id="about-card-name">Sampot (山姆鍋)</h4>
        
            <div id="about-card-bio"><p>個人部落格， 記錄與分享一些軟體開發與運維相關資訊， 偶爾也會碎念一下</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>IT 自由工作者</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                台灣/台北
            </div>
        
    </div>
</div>

        
            <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-times"></i></span>
            <a href="https://algolia.com" target="_blank" rel="noopener" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="/assets/images/logo-algolia-nebula-blue-full.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    />
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">沒有找到文章</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2012/03/set-up-mysql-master-master-replication/"
                            aria-label=": 設定 MySQL Master-Master 複製"
                        >
                            <h3 class="media-heading">設定 MySQL Master-Master 複製</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2012年3月3日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>本文簡單說明如何設定兩台 MySQL server，讓它們彼此互相備份資料 (Master-master 模式)。雖然這樣的設定通常是支援高可用性 (high availability) 平台的一部分，但本文不包含如何完成其他 HA 的工作。設定兩台 MySQL 伺服器互相備份，主要目的就是要確認資料的安全性；同時也提高可用性。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2012/04/use-pacemaker-two-node-ha-cluster/"
                            aria-label=": 使用 Pacemaker 建構雙節點叢集系統"
                        >
                            <h3 class="media-heading">使用 Pacemaker 建構雙節點叢集系統</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2012年4月6日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>想要達到系統高可用性 (high availability) 的需求，自然免不了需要採用現成的解決方案。本文說明如何利用 Pacemaker/heartbeat 來建構一個雙節點的從其系統。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2012/04/build-cluster-filesystem-with-glusterfs-ubuntu/"
                            aria-label=": 使用 GlusterFS 在 Ubuntu 上建構雙節點叢集檔案系統"
                        >
                            <h3 class="media-heading">使用 GlusterFS 在 Ubuntu 上建構雙節點叢集檔案系統</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2012年4月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>在網站的叢集系統中，除了資料庫需要讓各個伺服器存取外，常常也會需要讓檔案 (圖檔，CSS 等等) 可以被叢集中的伺服器存取。 傳統上，常常使用 NFS 伺服器來達到此目的，但 NFS 本身往往成為單一失敗點 (single point of failure)。 本文介紹 GlusterFS 來建構一個簡單的雙節點叢集檔案系統，具備高可用性、高擴充性等特性。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2012/04/scale-wordpress-with-hyperdb/"
                            aria-label=": 使用 HyperDB 加強 WordPress 網站的資料庫擴充性"
                        >
                            <h3 class="media-heading">使用 HyperDB 加強 WordPress 網站的資料庫擴充性</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2012年4月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>對於流量高的 Wordpress 網站來說，資料庫往往是第一個出現的瓶頸。針對資料庫擴充性的問題，本文介紹 HyperDB 這個解決方案。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2012/04/create-lnmp-environment-with-nginx/"
                            aria-label=": 在 Linode 上使用 Nginx 架設 LNMP 環境"
                        >
                            <h3 class="media-heading">在 Linode 上使用 Nginx 架設 LNMP 環境</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2012年4月30日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>Apache HTTPd 是很好的網站伺服器，但是對於 CPU 跟記憶體的要求較高，對於架設在 VPS 上面網站來說， 需要一個更輕量級的解決方案。越來越多人選擇使用 Nginx 架設網站，主要考量便是它的快速、穩定以及輕量的特性。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2012/05/support-sending-mail-php-linux-vps-exim/"
                            aria-label=": Linux VPS PHP 網站可以發送信件"
                        >
                            <h3 class="media-heading">Linux VPS PHP 網站可以發送信件</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2012年5月8日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>PHP 架站軟體通常需要用到寄信功能，例如：通知站長有新的迴響需要審核。使用虛擬主機來架站的讀者一定會納悶：<br>
不管是 WordPress，Drupal 或者其他 PHP<br>
架站軟體不是都不用另外設定就可以寄信？為什麼需要特地提到這件事情。<br>
話說山姆鍋的主機採用的是 Linode VPS，很多事情都需要自己來，唉！<br>
如果您的網站主機跟山姆鍋一樣是 VPS 或者專屬伺服器，那這篇文章也許對您有幫助。<br>
由於不是要做為公司的郵件伺服器，山姆鍋希望除了讓 PHP 架站軟體送信外，不再作其它用途。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2013/04/start-up/"
                            aria-label=": 影化身科技有限公司成立"
                        >
                            <h3 class="media-heading">影化身科技有限公司成立</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年4月24日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>2013 年 4 月 24 日，影化身科技有限公司登記成立，致力於提供雲端服務平台。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2013/05/shi-yong-octopresszuo-wei-bo-ke-ping-tai/"
                            aria-label=": 使用 Octopress 作為部落格平台"
                        >
                            <h3 class="media-heading">使用 Octopress 作為部落格平台</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月23日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>由於沒有需要太多動態功能，所以，嘗試使用靜態部落格平台 Octopress 來寫文章。「艾米部落」<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> 一路從 Joomla, Drupal, WordPress 到現在的 Octopress，也算是換了不少平台。</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2013/05/use-static-site-generator-for-company-site/"
                            aria-label=": 使用靜態網頁產生器來管理公司網站"
                        >
                            <h3 class="media-heading">使用靜態網頁產生器來管理公司網站</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月28日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>對於不需要動態功能的網站而言，使用像是 Drupal、WordPress 之類的架站軟體，感覺有點大材小用。對於可以接受不使用「所見即所得」編輯器的人，靜態網站產生器應該是個可以接受的方案。 雖說是靜態網站，缺少很多功能，但像是公司或者行銷網站往往也不需要這些。況且， 靜態網站有諸多動態網站所沒有的功能，如：</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a
                            class="link-unstyled"
                            href="https://samkuo.me/post/2013/05/exchange-name-card-with-eavatar-me/"
                            aria-label=": 如何利用「我．影化身」服務交換名片"
                        >
                            <h3 class="media-heading">如何利用「我．影化身」服務交換名片</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    2013年5月29日
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"><p>今天從 MR JAMIE 上讀到一篇文章：「從今天開始，請 email 你的名片給我吧！」這讓我想到，與其使用 Email，使用「我．影化身」來代替，不是也很適當？</p></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="沒有找到文章"
                data-message-one="找到 1 篇文章"
                data-message-other="找到 {n} 篇文章">
                找到 130 篇文章
            </p>
        </div>
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/images/cover.jpg');"></div>
        <!--SCRIPTS-->

<script src="/assets/js/script-597bjprixrfzrennpanwcwfnulsqaw08wvkzphw7gk8dqunvgzd9nn3nvsu9.min.js"></script>

<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://samkuo.me/post/2020/06/my-k8s-devops-lab-control-plane-endpoint/';
              
            this.page.identifier = 'post/2020/06/my-k8s-devops-lab-control-plane-endpoint/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'sampotkuo';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
    



    
<script src="/assets/js/moment-with-locales.js"></script>

    
<script src="/assets/js/algoliasearch.js"></script>

    <script>
      var algoliaClient = algoliasearch('OIWK4CBFS4', 'f676051199368fe5f161c9012b7edaf6');
      var algoliaIndex = algoliaClient.initIndex('MyBlogIndex');
    </script>


    </body>
</html>
